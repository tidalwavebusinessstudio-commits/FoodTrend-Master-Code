/**
 * PRIME DIRECTIVE - Crash Data Collection Script
 * 
 * This script automatically collects diagnostic data when the agent crashes or freezes.
 * Mandated by: .agent/PRIME_DIRECTIVE.md - Section 3
 */

const fs = require('fs');
const path = require('path');

class CrashDataCollector {
    constructor() {
        this.crashDir = path.join(__dirname, '../errors/agent-crash');
        this.ensureDirectoryExists();
    }

    ensureDirectoryExists() {
        if (!fs.existsSync(this.crashDir)) {
            fs.mkdirSync(this.crashDir, { recursive: true });
        }
    }

    collectCrashData(error, context = {}) {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `crash_${timestamp}.md`;
        const filepath = path.join(this.crashDir, filename);

        const crashReport = this.generateCrashReport(error, context);

        fs.writeFileSync(filepath, crashReport, 'utf8');
        console.log(`[PRIME DIRECTIVE] Crash data collected: ${filepath}`);

        return filepath;
    }

    generateCrashReport(error, context) {
        const timestamp = new Date().toISOString();

        return `# Agent Crash Report - ${timestamp}

## Error Details
- **Timestamp:** ${timestamp}
- **Error Type:** ${error.name || 'Unknown'}
- **Error Message:** ${error.message || 'No message'}
- **Location:** ${error.fileName || 'Unknown'}:${error.lineNumber || 'Unknown'}

## Stack Trace
\`\`\`
${error.stack || 'No stack trace available'}
\`\`\`

## Context at Crash
- **Last Successful Action:** ${context.lastAction || 'Unknown'}
- **Failed Action:** ${context.failedAction || 'Unknown'}
- **Open Files:** ${JSON.stringify(context.openFiles || [], null, 2)}
- **Recent Commands:** ${JSON.stringify(context.recentCommands || [], null, 2)}
- **Working Directory:** ${context.cwd || process.cwd()}

## System Information
- **Node Version:** ${process.version}
- **Platform:** ${process.platform}
- **Architecture:** ${process.arch}
- **Memory Usage:** ${JSON.stringify(process.memoryUsage(), null, 2)}
- **Uptime:** ${process.uptime()}s

## Hypothesis
${this.generateHypothesis(error, context)}

## Recovery Steps
1. Review this crash report
2. Check for similar crashes in \`.agent/errors/agent-crash/\`
3. Identify common patterns
4. Implement prevention automation
5. Update troubleshooting guide

## Prevention Automation
- [ ] Add error handling for this case
- [ ] Create unit test to prevent regression
- [ ] Update \`.agent/troubleshooting.md\`
- [ ] Create workflow if repeatable pattern

## Related Issues
- Search for: \`${error.name}\`
- Check: .agent/errors/agent-crash/ for similar reports

---
*This report was auto-generated by the Prime Directive crash collection system.*
*See: .agent/PRIME_DIRECTIVE.md - Section 3*
`;
    }

    generateHypothesis(error, context) {
        const hypotheses = [];

        if (error.message && error.message.includes('memory')) {
            hypotheses.push('- Memory exhaustion: Large file processing or infinite loop suspected');
        }

        if (error.message && error.message.includes('timeout')) {
            hypotheses.push('- Operation timeout: Long-running synchronous operation blocked execution');
        }

        if (error.name === 'TypeError') {
            hypotheses.push('- Type mismatch: Unexpected data type received, possibly from user input or API');
        }

        if (error.name === 'ReferenceError') {
            hypotheses.push('- Missing dependency: Required module or variable not found');
        }

        if (context.failedAction) {
            hypotheses.push(`- Action-specific failure: "${context.failedAction}" encountered unexpected condition`);
        }

        if (hypotheses.length === 0) {
            hypotheses.push('- Unknown cause: Requires manual investigation');
        }

        return hypotheses.join('\n');
    }

    // Hook into process error handlers
    setupGlobalHandlers() {
        process.on('uncaughtException', (error) => {
            console.error('[PRIME DIRECTIVE] Uncaught Exception Detected');
            this.collectCrashData(error, {
                failedAction: 'Uncaught Exception',
                lastAction: 'Unknown',
                cwd: process.cwd()
            });
            process.exit(1);
        });

        process.on('unhandledRejection', (reason, promise) => {
            console.error('[PRIME DIRECTIVE] Unhandled Promise Rejection');
            const error = reason instanceof Error ? reason : new Error(String(reason));
            this.collectCrashData(error, {
                failedAction: 'Unhandled Promise Rejection',
                lastAction: 'Unknown',
                promise: String(promise)
            });
        });
    }
}

// Export singleton instance
const collector = new CrashDataCollector();

// Auto-setup global handlers if running directly
if (require.main === module) {
    collector.setupGlobalHandlers();
    console.log('[PRIME DIRECTIVE] Crash data collector initialized');
}

module.exports = collector;
