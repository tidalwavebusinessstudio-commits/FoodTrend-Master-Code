<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Find Gigs - FoodTrend (v2)</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Core Engine -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <!-- Background Engine -->
  <div class="map-bg"></div>

  <!-- Sticky Header -->
  <header class="app-header glass">
    <div class="logo">
      <i class="ph-fill ph-fire text-primary"></i>
      FoodTrend
    </div>
    <div class="user-avatar-btn" onclick="toggleMenu()">
      <i class="ph ph-list text-white" style="font-size: 20px;"></i>
    </div>
  </header>

  <!-- Floating Search Bar -->
  <div class="search-container">
    <div class="search-bar glass">
      <i class="ph ph-magnifying-glass text-gray"></i>
      <input type="text" id="searchInput" class="search-input" placeholder="Search gigs, cravings, or tags..."
        onkeyup="filterGigs()">

      <!-- View Toggle inside Search for Compactness -->
      <div class="view-toggle">
        <button class="toggle-btn active" id="btn-list" onclick="switchView('list')"><i
            class="ph-fill ph-list-dashes"></i></button>
        <button class="toggle-btn" id="btn-map" onclick="switchView('map')"><i
            class="ph-fill ph-map-trifold"></i></button>
      </div>
    </div>
  </div>

  <!-- Side Menu Overlay -->
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <nav class="side-menu glass" id="sideMenu">
    <div style="margin-bottom: 30px; font-weight:800; font-size:24px;">Menu</div>
    <a href="profile.html" class="menu-link"><i class="ph ph-user-circle"></i> My Profile</a>
    <a href="referrals.html" class="menu-link"><i class="ph ph-currency-dollar"></i> Refer & Earn</a>
    <a href="academy.html" class="menu-link"><i class="ph ph-graduation-cap"></i> Academy</a>
    <a href="shop.html" class="menu-link"><i class="ph ph-storefront"></i> Shop</a>
    <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
      <a onclick="logout()" class="menu-link" style="color: #ff4444;"><i class="ph ph-sign-out"></i> Log Out</a>
    </div>
  </nav>

  <!-- Main Content Grid -->
  <main class="gigs-grid" id="gigs-container">
    <!-- JS will populate cards here -->
    <div style="grid-column: 1/-1; text-align:center; padding-top:40px; color:var(--text-gray);">
      <i class="ph ph-spinner-gap" style="font-size: 24px; animation: spin 1s linear infinite;"></i>
      <p style="margin-top:10px;">Finding the best eats...</p>
    </div>
  </main>

  <!-- GHL Booking Modal Placeholder -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal-content glass">
      <button class="close-modal" onclick="closeBooking()"><i class="ph ph-x"></i></button>
      <div style="text-align:center; padding-top: 30px;">
        <i class="ph ph-calendar-check text-primary" style="font-size: 48px; margin-bottom: 15px;"></i>
        <h3 id="modalTitle">Book Your Gig</h3>
        <p class="text-gray" style="font-size: 14px; line-height: 1.5; margin-bottom: 20px;">
          This is where the <b>GoHighLevel Calendar</b> widget will load.<br>
          Influencers will pick a time, and the webhook will sync it back to your schedule.
        </p>
        <div
          style="background: rgba(0,0,0,0.3); border-radius: 12px; height: 180px; display:grid; place-items:center; border: 2px dashed rgba(255,255,255,0.1);">
          [ GHL Calendar Iframe ]
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav glass">
    <a href="gigs.html" class="nav-item active"><i class="ph-fill ph-magnifying-glass"></i> Gigs</a>
    <a href="schedule.html" class="nav-item"><i class="ph ph-calendar-blank"></i> Plan</a>
    <a href="upload.html" class="nav-item"><i class="ph ph-plus-circle"></i> Post</a>
    <a href="shop.html" class="nav-item"><i class="ph ph-storefront"></i> Shop</a>
    <a href="profile.html" class="nav-item"><i class="ph ph-user"></i> You</a>
  </nav>

  <style>
    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }
  </style>

  <script>
    // --- CONFIG ---
    const sbUrl = 'https://vsgljspzmynbqfyuvyyl.supabase.co';
    const sbKey = 'sb_publishable_eH52Wo-WDJ7WkasY4GejOw_b0xUYZ-_';
    const db = supabase.createClient(sbUrl, sbKey);

    let allGigs = [];

    // Local Asset Stock for "Random" Assignment
    const stockImages = [
      'assets/meat-6924014_1280.jpg',
      'assets/korean-dish-4854695_1280.jpg',
      'assets/pexels-ali-dashti-506667798-21856038.jpg',
      'assets/pexels-nadin-sh-78971847-13749941.jpg',
      'assets/christmas-wallpaper-2009590_1280.jpg'
    ];

    // --- CORE FUNCTIONS ---
    async function loadGigs() {
      // Fetch real data from Supabase
      const { data: restaurants, error } = await db.from('restaurants').select('*');

      if (error || !restaurants || restaurants.length === 0) {
        document.getElementById('gigs-container').innerHTML =
          `<div style="text-align:center; grid-column:1/-1; padding:40px; color:#888;">No gigs found. Check your connection.</div>`;
        return;
      }

      // Hydrate with Mock Data (Images/Tags) until backend has them
      allGigs = restaurants.map((r, i) => ({
        ...r,
        // Assign a random image from our assets based on index (deterministic for demo)
        image_url: stockImages[i % stockImages.length],
        tags: generateTags(r.name),
        distance: (0.4 + (i * 0.2)).toFixed(1) + ' mi',
        free_item: getFreeItem(r.name)
      }));

      renderGigs(allGigs);
    }

    function renderGigs(list) {
      const container = document.getElementById('gigs-container');
      container.innerHTML = '';

      if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; grid-column:1/-1; padding:20px; color:#666;">No matches found.</div>';
        return;
      }

      list.forEach(gig => {
        container.innerHTML += `
                    <a href="javascript:openBooking('${gig.name}')" class="gig-card glass">
                        <div class="offer-pill">${gig.free_item}</div>
                        <div class="card-image-box">
                            <img src="${gig.image_url}" class="card-img" alt="${gig.name}">
                            <div class="card-overlay"></div>
                        </div>
                        <div class="card-content">
                            <div class="card-header">
                                <h3 class="res-name">${gig.name}</h3>
                                <span class="res-distance"><i class="ph-fill ph-map-pin"></i> ${gig.distance}</span>
                            </div>
                            <div class="tags-row">
                                ${gig.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                            </div>
                        </div>
                    </a>
                `;
      });
    }

    // --- HELPERS (SIMULATION) ---
    function generateTags(name) {
      const tags = ['Influencer-Friendly'];
      if (name.toLowerCase().includes('steak')) tags.push('Steakhouse', 'Dinner');
      else if (name.toLowerCase().includes('sushi')) tags.push('Japanese', 'Seafood');
      else if (name.toLowerCase().includes('pizza')) tags.push('Italian', 'Comfort');
      else if (name.toLowerCase().includes('coffee')) tags.push('Cafe', 'Breakfast');
      else tags.push('Casual Dining', 'Trending'); // Default
      return tags;
    }

    function getFreeItem(name) {
      const lower = name.toLowerCase();
      if (lower.includes('burger')) return 'Free Smashburger';
      if (lower.includes('pizza')) return 'Free Lg Pepperoni';
      if (lower.includes('sushi')) return 'Free Tuna Roll';
      if (lower.includes('coffee')) return 'Free Cold Brew';

      return 'Free Entree'; // Fallback
    }

    function filterGigs() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allGigs.filter(gig =>
        gig.name.toLowerCase().includes(query) ||
        gig.tags.some(t => t.toLowerCase().includes(query))
      );
      renderGigs(filtered);
    }

    // --- UI INTERACTION ---
    function toggleMenu() {
      document.getElementById('sideMenu').classList.toggle('open');
      document.getElementById('menuOverlay').classList.toggle('open');
    }

    function switchView(mode) {
      document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`btn-${mode}`).classList.add('active');

      if (mode === 'map') {
        alert("The Map View feature will be enabled in the next update!");
        // Revert toggle visually for now since map isn't built
        document.getElementById('btn-list').click();
      }
    }

    function openBooking(restaurantName) {
      document.getElementById('modalTitle').innerText = `Book @ ${restaurantName}`;
      document.getElementById('bookingModal').classList.add('active');
    }

    function closeBooking() {
      document.getElementById('bookingModal').classList.remove('active');
    }

    async function logout() { await db.auth.signOut(); window.location.href = 'index.html'; }

    // Start
    loadGigs();

  </script>
</body>

</html>